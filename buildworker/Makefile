include ../common.mk

buildall:

# Build "buildall" target that builds the docker-compose directories
$(foreach f,$(HFS),$(eval $(call add_dep,buildall,build-$(f))))

# Build "delpoyall" target that brings up all images that are compatible with our arch
$(foreach f,$(BUILD_HFS),$(eval $(call add_dep,deployall,deploy-$(f))))

# Build "downall" target that takes down all workers that are compatible with our arch
$(foreach f,$(BUILD_HFS),$(eval $(call add_dep,downall,down-$(f))))

# Here's where we take our templates and build docker-compose files out of them
define build_dockercompose
build-$(1): build/$(1)/docker-compose.yml
build/$(1)/docker-compose.yml: docker-compose.template.yml Dockerfile.template start_worker.sh secret.env ../workerbase/$(1).harbor
	@echo $(1)
	@rm -rf "build/$(1)"
	@mkdir -p "build/$(1)/worker"
	@ln -sf ../../secret.env "build/$(1)/.env"
	@sed -e "s/{service_name}/$(1)/g" docker-compose.template.yml > "build/$(1)/docker-compose.yml"
	@case $(call tag_name,$(1)) in \
		*x86) sed -i.bak -e "s/{linux32}/linux32/g" "build/$(1)/docker-compose.yml";; \
		*)    sed -i.bak -e "s/{linux32}/       /g" "build/$(1)/docker-compose.yml";; \
	esac
	@rm -f build/$(1)/*.bak
	@echo "## This file was autogenerated" > "build/$(1)/worker/Dockerfile"
	@echo "# Do not edit directly; edit the template files" >> "build/$(1)/worker/Dockerfile"
	@echo "FROM $(call tag_name,$(1))" >> "build/$(1)/worker/Dockerfile"
	@cat Dockerfile.template >> "build/$(1)/worker/Dockerfile"
	@cp ./start_worker.sh "build/$(1)/worker/start_worker.sh"

pull-$(1):
	docker pull $(call tag_name,$(1))

deploy-$(1): build-$(1)
	@# Build our new worker, take down the old one and bring the new one up
	@cd build/$(1); \
	docker-compose build --pull; \
	docker-compose down --remove-orphans; \
	COMPOSE_HTTP_TIMEOUT=300 docker-compose up -d

down-$(1):
	@if [ -d build/$(1) ]; then \
		cd build/$(1); \
		docker-compose down --remove-orphans; \
	fi
endef

# Call build_dockercompose on each and every harborfile
$(foreach f,$(HFS),$(eval $(call build_dockercompose,$(f))))


clean: downall
	rm -rf build

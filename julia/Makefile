include ../common.mk

# By default, build all the dockerfiles
all: dockerfiles

# All the versions we'll generate Dockerfiles for
VERS:=$(VERS) v0.5.0 v0.5.1 v0.5.2
VERS:=$(VERS) v0.6.0-rc2

# Convenience function to build the docker tag for an image 
define julia_tag_name
$(strip staticfloat/julia:$(firstword $(subst -, ,$(2)))-$(1))
endef

# Arch-dependent values
ARCHS=x64 x86 ppc64le aarch64 armv7l
IMAGE-x64=multiarch/debian-debootstrap:amd64-jessie
IMAGE-x86=multiarch/debian-debootstrap:i386-jessie
IMAGE-ppc64le=multiarch/debian-debootstrap:ppc64el-jessie
IMAGE-aarch64=multiarch/debian-debootstrap:arm64-jessie
IMAGE-armv7l=multiarch/debian-debootstrap:armhf-jessie

# Only on x86 and armv7l will we set L32
L32-x86=linux32
L32-armv7l=linux32

define major_version
$(strip $(shell echo $(1) | sed -E -n 's/v?([0-9]+\.[0-9]+).*/\1/p'))
endef

# Grumble grumble inconsistency
TAR_ARCH-x64=x86_64
TAR_ARCH-x86=i686
TAR_ARCH-ppc64le=ppc64le
TAR_ARCH-aarch64=aarch64
TAR_ARCH-armv7l=armv7l

define JULIA_URL
$(strip https://julialang-s3.julialang.org/bin/linux/$(1)/$(call major_version,$(2))/julia-$(2)-linux-$(TAR_ARCH-$(1)).tar.gz)
endef

define build_dockerfile
build/$(2)/Dockerfile.$(1): Makefile Dockerfile
	@mkdir -p $$(dir $$@)
	@echo $(2)-$(1)
	@echo "## This file was autogenerated" > "$$@"
	@echo "# Do not edit directly; edit Makefile and top-level Dockerfile" >> "$$@"
	@echo "FROM $(IMAGE-$(1))" >> "$$@"
	@echo "ARG JULIA_URL=\"$(call JULIA_URL,$(1),$(2))\"" >> "$$@"
	@echo "ARG L32=\"$(L32-$(1))\"" >> "$$@"
	@echo >> "$$@"
	@cat Dockerfile >> "$$@"

build-$(2)-$(1): build/$(2)/Dockerfile.$(1)
	$(DOCKER_BUILD) --pull -t $(call julia_tag_name,$(1),$(2)) -f build/$(2)/Dockerfile.$(1) build/$(2)

push-$(2)-$(1):
	docker push staticfloat/julia:$(call julia_tag_name,$(1),$(2))
endef

# Construct the actual build targets for all the dockerfiles
$(foreach v,$(VERS),$(foreach a,$(ARCHS),$(eval $(call build_dockerfile,$(a),$(v)))))

# Build "dockerfiles" target that assembles all Dockerfiles
$(foreach v,$(VERS),$(foreach a,$(ARCHS),$(eval $(call add_dep,dockerfiles,build/$(v)/Dockerfile.$(a)))))

# Build "buildall" target that attempts to build every Dockerfile in the room,
# but only from the ones that our build architecture can manage.
$(foreach v,$(VERS),$(foreach a,$(BUILD_ARCHS),$(eval $(call add_dep,buildall,build-$(v)-$(a)))))

# Build "pushall" target that pushes up the result of "buildall"
$(foreach v,$(VERS),$(foreach a,$(BUILD_ARCHS),$(eval $(call add_dep,pushall,push-$(v)-$(a)))))

clean:
	rm -rf build
